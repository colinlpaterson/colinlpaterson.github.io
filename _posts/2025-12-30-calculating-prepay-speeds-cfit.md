---
layout: post
title: "Calculating Loan Portfolio Prepay Speeds in R Using the cfit Package"
date: 2025-12-30
categories: [r-programming, finance]
excerpt: "How to efficiently calculate loan portfolio prepay speeds with confidence and transparency."
---

## The Problem

Loan portfolio prepayment speeds are critical inputs for forecasting, CECL, and ALM models. Small errors compound quickly.

Many institutions calculate these in Excel on an ad-hoc basis, resulting in inconsistent formulas, manual processes, and prone to errors. (Or they pay a vendor to do the calculation.)

## The Solution: calculate_prepay_speed()

This function standardizes the calculation of prepay speeds in a loan portfolio. Its benefits include:

- **Transparent** - The 'how' of the calculation is clearly documented in both the open-source script (on GitHub) and in the help documentation. There is no inconsistent or 'black box' calculation. 
- **Reproducible** - calculations can get regenerated by running the same script, thus making outputs audit ready.
- **Efficient** - By building a scripting workflow (Import data -> Clean/Wrangle -> calculate_prepay_speed() -> output), users efficiently calculate loan portfolio speeds in a consistent manner.

### Basic Usage
```r
calculate_prepay_speed(df, group_vars, prepay_config, verbose = FALSE)
```

The function requires:
- `df` - Loan-level snapshot data
- `group_vars` - How to group results (e.g., by month and product)
- `prepay_config` - Column mappings (fully customizable)

All column mappings are configurable via `prepay_config`. See `?calculate_prepay_speed` for configuration details.

## Real-World Example

Below are examples of calculating prepay speeds on a custom data frame of loans.

The goal is to calculate the prepay speed by Product within each month. The first example assumes the account number is not provided

```r
# install.packages("devtools") #if needed
#Install  from GitHub
devtools::install_github("CommunityFIT/cfit")
#Load cfit library
library(cfit)

#No Account Number in data frame
df_custom_1 <- data.frame(
  ReportDate = as.Date(c(
    "2024-01-31", "2024-02-29", "2024-03-31", "2024-04-30",  # Loan 100
    "2024-01-31", "2024-02-29", "2024-03-31", "2024-04-30",  # Loan 101
    "2024-01-31", "2024-02-29", "2024-03-31", "2024-04-30",  # Loan 102
    "2024-01-31", "2024-02-29", "2024-03-31", "2024-04-30"   # Loan 103
  )),
 # AcctNbr = c(
  #  100, 100, 100, 100,
  # 101, 101, 101, 101,
  #  102, 102, 102, 102,
  #  103, 103, 103, 103
#  ),
  OpenDate = as.Date(c(
    "2023-01-15", "2023-01-15", "2023-01-15", "2023-01-15",  # Loan 100
    "2023-06-10", "2023-06-10", "2023-06-10", "2023-06-10",  # Loan 101
    "2023-09-20", "2023-09-20", "2023-09-20", "2023-09-20",  # Loan 102
    "2023-12-15", "2023-12-15", "2023-12-15", "2023-12-15"   # Loan 103 - fixed!
  )),
  Product = c(
    "AUTONEW", "AUTONEW", "AUTONEW", "AUTONEW",
    "AUTONEW", "AUTONEW", "AUTONEW", "AUTONEW",
    "AUTOUSED", "AUTOUSED", "AUTOUSED", "AUTOUSED",
    "AUTOUSED", "AUTOUSED", "AUTOUSED", "AUTOUSED"
  ),
  CurrentBalance = c(
    10000, 9500, 9000, 8700,
    15000, 14500, 14000, 13200,
    8000, 7600, 7200, 6800,
    19000, 18500, 17500, 16000
  ),
  StartingBalance = c(
    12000, 12000, 12000, 12000,
    16000, 16000, 16000, 16000,
    9000, 9000, 9000, 9000,
    20000, 20000, 20000, 20000
  ),
  MonthlyPayment = c(
    206, 206, 206, 206,
    269, 269, 269, 269,
    160, 160, 160, 160,
    322, 322, 322, 322
  ),
  InterestRate = c(
    0.0729, 0.0729, 0.0729, 0.0729,
    0.0649, 0.0649, 0.0649, 0.0649,
    0.084, 0.084, 0.084, 0.084,
    0.09, 0.09, 0.09, 0.09
  )
)

custom_config_1 <- list(
  col_effdate = "ReportDate",
  col_origdate = "OpenDate",
  col_typecode = "Product",
  col_balance = "CurrentBalance",
  col_orig_balance = "StartingBalance",
  col_payment = "MonthlyPayment",
  col_rate = "InterestRate"
  #col_loanid = "AcctNbr"
)

result_1 <- calculate_prepay_speed(
  df = df_custom_1,
  group_vars = c("ReportDate", "Product"),
  prepay_config = custom_config_1
)

result_1
# A tibble: 6 × 10
  ReportDate Product  BEGIN_BAL END_BAL SCHED_PRIN_TOTAL FUNDED_BAL ACTUAL_PRIN PREPAYMENT    SMM   CPR
  <date>     <chr>        <dbl>   <dbl>            <dbl>      <dbl>       <dbl>      <dbl>  <dbl> <dbl>
1 2024-02-29 AUTONEW      25000   24000             345.          0        1000       655. 0.0266 0.276
2 2024-02-29 AUTOUSED     27000   26100             299.          0         900       601. 0.0225 0.239
3 2024-03-31 AUTONEW      24000   23000             342.          0        1000       658. 0.0278 0.287
4 2024-03-31 AUTOUSED     26100   24700             297.          0        1400      1103. 0.0428 0.408
5 2024-04-30 AUTONEW      23000   21900             352.          0        1100       748. 0.0330 0.332
6 2024-04-30 AUTOUSED     24700   22800             317.          0        1900      1583. 0.0649 0.553

# Interpretation of row 1:
# - AUTONEW loans in Feb: 2.66% monthly prepay rate (SMM)
# - Annualized: 27.6% CPR

```

The second example assumes the account number is included in the data frame.
```r
# install.packages("devtools") #if needed
#Install  from GitHub
devtools::install_github("CommunityFIT/cfit")
#Load cfit library
library(cfit)

#With Account Number in data frame
df_custom_2 <- data.frame(
  ReportDate = as.Date(c(
    "2024-01-31", "2024-02-29", "2024-03-31", "2024-04-30",  # Loan 100
    "2024-01-31", "2024-02-29", "2024-03-31", "2024-04-30",  # Loan 101
    "2024-01-31", "2024-02-29", "2024-03-31", "2024-04-30",  # Loan 102
    "2024-01-31", "2024-02-29", "2024-03-31", "2024-04-30"   # Loan 103
  )),
  AcctNbr = c(
    100, 100, 100, 100,
    101, 101, 101, 101,
    102, 102, 102, 102,
    103, 103, 103, 103
  ),
  OpenDate = as.Date(c(
    "2023-01-15", "2023-01-15", "2023-01-15", "2023-01-15",  # Loan 100
    "2023-06-10", "2023-06-10", "2023-06-10", "2023-06-10",  # Loan 101
    "2023-09-20", "2023-09-20", "2023-09-20", "2023-09-20",  # Loan 102
    "2023-12-15", "2023-12-15", "2023-12-15", "2023-12-15"   # Loan 103 - fixed!
  )),
  Product = c(
    "AUTONEW", "AUTONEW", "AUTONEW", "AUTONEW",
    "AUTONEW", "AUTONEW", "AUTONEW", "AUTONEW",
    "AUTOUSED", "AUTOUSED", "AUTOUSED", "AUTOUSED",
    "AUTOUSED", "AUTOUSED", "AUTOUSED", "AUTOUSED"
  ),
  CurrentBalance = c(
    10000, 9500, 9000, 8700,
    15000, 14500, 14000, 13200,
    8000, 7600, 7200, 6800,
    19000, 18500, 17500, 16000
  ),
  StartingBalance = c(
    12000, 12000, 12000, 12000,
    16000, 16000, 16000, 16000,
    9000, 9000, 9000, 9000,
    20000, 20000, 20000, 20000
  ),
  MonthlyPayment = c(
    206, 206, 206, 206,
    269, 269, 269, 269,
    160, 160, 160, 160,
    322, 322, 322, 322
  ),
  InterestRate = c(
    0.0729, 0.0729, 0.0729, 0.0729,
    0.0649, 0.0649, 0.0649, 0.0649,
    0.084, 0.084, 0.084, 0.084,
    0.09, 0.09, 0.09, 0.09
  )
)

custom_config_2 <- list(
  col_effdate = "ReportDate",
  col_origdate = "OpenDate",
  col_typecode = "Product",
  col_balance = "CurrentBalance",
  col_orig_balance = "StartingBalance",
  col_payment = "MonthlyPayment",
  col_rate = "InterestRate",
  col_loanid = "AcctNbr"
)

result_2 <- calculate_prepay_speed(
  df = df_custom_2,
  group_vars = c("ReportDate", "Product"),
  prepay_config = custom_config_2
)

result_2
# A tibble: 6 × 10
  ReportDate Product  BEGIN_BAL END_BAL SCHED_PRIN_TOTAL FUNDED_BAL ACTUAL_PRIN PREPAYMENT    SMM   CPR
  <date>     <chr>        <dbl>   <dbl>            <dbl>      <dbl>       <dbl>      <dbl>  <dbl> <dbl>
1 2024-02-29 AUTONEW      25000   24000             340.          0        1000       660. 0.0268 0.278
2 2024-02-29 AUTOUSED     27000   26100             293.          0         900       607. 0.0227 0.241
3 2024-03-31 AUTONEW      24000   23000             336.          0        1000       664. 0.0280 0.289
4 2024-03-31 AUTOUSED     26100   24700             286.          0        1400      1114. 0.0431 0.411
5 2024-04-30 AUTONEW      23000   21900             346.          0        1100       754. 0.0333 0.334
6 2024-04-30 AUTOUSED     24700   22800             303.          0        1900      1597. 0.0655 0.556

# Interpretation of row 1:
# - AUTONEW loans in Feb: 2.68% monthly prepay rate (SMM)
# - Annualized: 27.8% CPR


```
### Why Account Number Matters

Compare the February AUTONEW results:

| Version | SMM | CPR | Difference |
|---------|-----|-----|------------|
| Without loan ID | 0.0266 | 0.276 | Less accurate |
| With loan ID | 0.0268 | 0.278 | More accurate |

The difference is small here but compounds in portfolios with:
- Interest-only periods
- Variable rate loans
- Mixed payment structures

**Recommendation:** Always provide `col_loanid` when available.

## Why Not Just Use Excel?

Traditional Excel approaches have limitations:

| Excel | cfit |
|-------|------|
| Manual formulas per cohort | Automated for all cohorts |
| SMM often uses wrong denominator | Industry-standard SMM / CPR calculation method |
| No validation of duplicates | Built-in data quality checks |
| Hard to audit/reproduce | Version-controlled, documented |
| Difficult to scale | Handles thousands of loans easily |

## Technical Notes

**Calculation Methodology:**
- SMM uses pool available to prepay: `PREPAYMENT / (BEGIN_BAL - SCHED_PRIN)`
- CPR annualizes SMM: `1 - (1 - SMM)^12`
- First month excluded (no prior balance for lag)

**With vs Without Loan ID:**
- **With:** `SCHEDPRIN = PAYMENT - (BEGIN_BAL × RATE)`
- **Without:** `SCHEDPRIN ≈ PAYMENT - (END_BAL × RATE)` (approximation)

**Data Requirements:**
- One row per loan per reporting period
- Rates in decimal form (auto-converts from percentage with warning)
- Active loans only (open and non-performing)

**FUNDED_BAL:** Approximates new loan originations by matching origination month/year. Uses ORIGBAL, not actual cash flows.

## Get Started

Install from GitHub:
```r
devtools::install_github("CommunityFIT/cfit@v0.1.0")
```

**Resources:**
- [cfit GitHub repository](https://github.com/CommunityFIT/cfit)
- [Full documentation](https://github.com/CommunityFIT/cfit#readme)
- [Report issues](https://github.com/CommunityFIT/cfit/issues)

**Next Steps:**
- Try it with your own loan data
- Star the repo if you find it useful
- Contribute improvements or request features

---

*Part of the [CommunityFIT](https://github.com/CommunityFIT) initiative - open-source computational finance tools for community financial institutions.*


---

